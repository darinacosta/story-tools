!function(){"use strict";function e(){this.storyBoxes=[],this.map=null}var t=angular.module("storytools.core.boxes",[]),o=storytools.core.maps.boxes;e.prototype.boxesChanged=function(e,t){var o;if("delete"==t){for(o=0;o<e.length;o++)for(var r=e[o],n=0,a=this.storyBoxes.length;a>n;n++)if(this.storyBoxes[n].id==r.id){this.storyBoxes.splice(n,1);break}}else if("add"==t)for(o=0;o<e.length;o++)this.storyBoxes.push(e[o]);else if("change"!=t)throw new Error("action? :"+t);var i=this.storyBoxes.map(function(e){return e.range});this.map.storyBoxesLayer.set("times",i),this.map.storyBoxesLayer.set("features",this.storyBoxes)},e.prototype.loadFromGeoJSON=function(e,t,r){if(r&&(this.storyBoxes=[]),e&&e.features){var n=o.loadFromGeoJSON(e,t);this.boxesChanged(n,"add",!0)}},t.service("StoryBoxLayerManager",e),t.constant("StoryBox",o.Box)}(),function(){"use strict";var e=angular.module("storytools.core.legend.directives",[]),t=!1;e.directive("stLegend",["$rootScope","MapManager",function(e,o){return{restrict:"C",replace:!0,templateUrl:"legend/legend.html",link:function(e){e.mapManager=o;var r=function(){angular.element(document.getElementById("legend-container"))[0].style.visibility="visible",angular.element(document.getElementById("legend-panel"))[0].style.display="block",t=!0},n=function(){angular.element(document.getElementById("legend-panel"))[0].style.display="none",t=!1,setTimeout(function(){angular.element("#legend-container")[0].style.visibility="hidden"},350)};e.toggleLegend=function(){t===!1?(console.log(angular.element(document.getElementsByClassName("legend-item"))),r()):n()},e.getLegendUrl=function(e){var t=null,o="/geoserver/wms",r=e.get("typeName")||e.get("id");return t=o+"?request=GetLegendGraphic&format=image%2Fpng&width=20&height=20&layer="+r+"&transparent=true&legend_options=fontColor:0xFFFFFF;fontAntiAliasing:true;fontSize:14;fontStyle:bold;",e.get("params").STYLES&&(t+="&style="+e.get("params").STYLES),t},e.$on("layer-added",function(){t===!1&&r()}),e.$on("layerRemoved",function(){t===!0&&1==angular.element(".legend-item").length&&n()})}}}])}(),function(){"use strict";angular.module("storytools.core.legend",["storytools.core.legend.directives"])}(),function(){"use strict";var e=angular.module("storytools.core.mapstory",[]);e.service("stMapConfigStore",function(){function e(e){return"/maps/"+e}function t(t){var o=localStorage.getItem(e(t));return o=null===o?{}:angular.fromJson(o)}function o(t){localStorage.setItem(e(t.id),angular.toJson(t))}function r(){var e=[],t=new RegExp("/maps/(\\d+)$");return Object.getOwnPropertyNames(localStorage).forEach(function(o){var r=t.exec(o);r&&e.push({id:r[1]})}),e}function n(){var e=0,t=r().map(function(e){return e.id});return t.sort(),t.length&&(e=parseInt(t[t.length-1])),e+1}return{listMaps:function(){return r()},loadConfig:function(e){return t(e)},saveConfig:function(e){angular.isDefined(e.id)||(e.id=n()),o(e)}}})}(),function(){"use strict";function e(e){ol.Object.call(this,e),this.map_=new ol.Map({target:e.target,pixelRatio:1}),this.overlay=new ol.FeatureOverlay({map:this.map_,style:a}),this.title="Default Mapstory",this.abstract="No Information Supplied.",this.owner="",this.mode="instant",this.returnToExtent=e.returnToExtent||!1,this.center=[0,0],this.zoom=2,this.storyLayers_=new ol.Collection,this.animationDuration_=e.animationDuration||500,this.storyBoxesLayer=new o({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:a})}),this.storyPinsLayer=new o({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:a})}),this.addStoryPinsLayer(),this.addStoryBoxesLayer()}function t(t){e.call(this,t)}function o(e){e.times&&storytools.core.time.utils.isRangeLike(e.times)&&(e.times=new storytools.core.time.utils.Interval(e.times)),ol.Object.call(this,e);var t;if("VECTOR"===this.get("type"))t=new ol.layer.Vector({source:new ol.source.Vector});else if("HEATMAP"===this.get("type"))t=new ol.layer.Heatmap({radius:e.style.radius,opacity:e.style.opacity,source:new ol.source.Vector});else if("WMS"===this.get("type")){var o={useOldAsInterimTiles:!0};t=this.get("singleTile")===!0?new ol.layer.Image(o):new ol.layer.Tile(o)}else t=e.layer;this.layer_=t}function r(e){o.call(this,e)}var n=angular.module("storytools.core.ogc",[]),a=[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1}),image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1})})})];e.prototype=Object.create(ol.Object.prototype),e.prototype.constructor=e,e.prototype.addStoryPinsLayer=function(){this.map_.addLayer(this.storyPinsLayer.getLayer())},e.prototype.addStoryBoxesLayer=function(){this.map_.addLayer(this.storyBoxesLayer.getLayer())},e.prototype.setStoryOwner=function(e){this.owner=e},e.prototype.getStoryOwner=function(){return this.owner},e.prototype.getCenter=function(){return this.center},e.prototype.getZoom=function(){return this.zoom},e.prototype.setStoryTitle=function(e){this.title=e},e.prototype.setCenter=function(e){this.center=e},e.prototype.setZoom=function(e){this.zoom=e},e.prototype.setMode=function(e){this.mode=e},e.prototype.setStoryAbstract=function(e){this.abstract=e},e.prototype.getStoryTitle=function(){return this.title},e.prototype.getStoryAbstract=function(){return this.abstract},e.prototype.setBaseLayer=function(e){this.set("baselayer",e),this.map_.getLayers().forEach(function(e){"background"===e.get("group")&&this.map_.removeLayer(e)},this),this.map_.getLayers().insertAt(0,this.get("baselayer"))},e.prototype.addStoryLayer=function(e){e.storyMap_=this,this.storyLayers_.push(e);var t=this.map_.getLayers().getLength(),o=this;this.map_.getLayers().forEach(function(e){e===o.storyPinsLayer&&(t-=1)}),this.map_.getLayers().insertAt(t,e.getLayer())},e.prototype.getStoryLayers=function(){return this.storyLayers_},e.prototype.getMap=function(){return this.map_},e.prototype.clear=function(){this.map_.getLayers().clear(),this.storyLayers_.clear(),this.addStoryPinsLayer()},e.prototype.animatePanAndBounce=function(e,t){var o=2e3,r=+new Date,n=this.map_.getView();if(n.getCenter()!=e){var a=ol.animation.pan({duration:this.animationDuration_,source:n.getCenter(),start:r}),i=ol.animation.bounce({duration:o,resolution:2*n.getResolution(),start:r});this.map_.beforeRender(a,i),n.setCenter(e),n.setZoom(t)}},e.prototype.animateCenterAndZoom=function(e,t){var o=this.map_.getView();(o.getCenter()!==e||o.getZoom()!==t)&&(this.map_.beforeRender(ol.animation.pan({duration:this.animationDuration_,source:o.getCenter()})),o.setCenter(e),this.map_.beforeRender(ol.animation.zoom({resolution:o.getResolution(),duration:this.animationDuration_})),o.setZoom(t))},e.prototype.setAllowPan=function(e){this.map_.getInteractions().forEach(function(t){(t instanceof ol.interaction.KeyboardPan||t instanceof ol.interaction.DragPan)&&t.setActive(e)})},e.prototype.setAllowZoom=function(e){var t;this.map_.getControls().forEach(function(e){e instanceof ol.control.Zoom&&(t=e)}),e?this.map_.addControl(new ol.control.Zoom):this.map_.removeControl(t),this.map_.getInteractions().forEach(function(t){(t instanceof ol.interaction.DoubleClickZoom||t instanceof ol.interaction.PinchZoom||t instanceof ol.interaction.DragZoom||t instanceof ol.interaction.MouseWheelZoom)&&t.setActive(e)})},n.constant("StoryMap",e),t.prototype=Object.create(e.prototype),t.prototype.constructor=t,n.constant("EditableStoryMap",t),t.prototype.getState=function(){var e={};e.map={center:this.map_.getView().getCenter(),projection:this.map_.getView().getProjection().getCode(),zoom:this.map_.getView().getZoom(),layers:[]};var t=this.get("id");t>=0&&(e.id=t);var o=this.get("baselayer");if(o){var r=this.get("baselayer").get("state");r.group="background",r.visibility=!0,e.map.layers.push(r)}return this.storyLayers_.forEach(function(t){e.map.layers.push(t.getState())}),e},t.prototype.removeStoryLayer=function(e){this.storyLayers_.remove(e),this.map_.removeLayer(e.getLayer())},o.prototype=Object.create(ol.Object.prototype),o.prototype.constructor=o,o.prototype.getStoryMap=function(){return this.storyMap_},o.prototype.setWMSSource=function(){var e=this.getLayer(),t=this.get("name"),o=this.get("times"),r=this.get("singleTile"),n=this.get("params")||{LAYERS:t,VERSION:"1.1.0",TILED:!0};if(o&&(n.TIME=new Date(o.start||o[0]).toISOString()),r)e.setSource(new ol.source.ImageWMS({params:n,url:this.get("url"),serverType:"geoserver"}));else{var a,i=this.get("resolutions"),s=this.get("bbox");i&&s&&(a=new ol.tilegrid.TileGrid({extent:s,resolutions:i})),e.setSource(new ol.source.TileWMS({url:this.get("url"),params:n,tileGrid:a,serverType:"geoserver"}))}},o.prototype.getState=function(){var e=this.getProperties();return delete e.features,e},o.prototype.getLayer=function(){return this.layer_},o.prototype.setLayer=function(e){if(this.layer_&&this.storyMap_){var t=this.storyMap_.map_,o=t.getLayers().getArray().indexOf(this.layer_);t.getLayers().setAt(o,e)}this.layer_=e},n.constant("StoryLayer",o),r.prototype=Object.create(o.prototype),r.prototype.constructor=r,n.constant("EditableStoryLayer",r),n.service("stAnnotateLayer",["$http","$q",function(e,t){return{loadCapabilities:function(t){var o="GetCapabilities",r="WMS",n=t.get("url");if("/geoserver/wms"===n){var a=t.get("name"),i=a.split(":");n=n.replace("/geoserver","/geoserver/"+i[0]+"/"+i[1])}return n=n.replace("http:",""),e({method:"GET",url:n,params:{REQUEST:o,SERVICE:r,VERSION:"1.1.1",TILED:!0}}).success(function(e){var o=new owsjs.Jsonix.Context([owsjs.mappings.WMSC_1_1_1]),r=o.createUnmarshaller(),n=r.unmarshalString(e),a=n.value.capability.layer;t.set("latlonBBOX",[parseFloat(a.latLonBoundingBox.minx),parseFloat(a.latLonBoundingBox.miny),parseFloat(a.latLonBoundingBox.maxx),parseFloat(a.latLonBoundingBox.maxy)]);for(var i=n.value.capability.vendorSpecificCapabilities,s=i?i.tileSet:[],l=0,u=s.length;u>l;++l)if("EPSG:900913"===s[l].srs){t.set("resolutions",s[l].resolutions.split(" "));var c=s[l].boundingBox;t.set("bbox",[parseFloat(c.minx),parseFloat(c.miny),parseFloat(c.maxx),parseFloat(c.maxy)]);break}var y=storytools.core.time.maps.readCapabilitiesTimeDimensions(n),p=t.get("name");p in y&&t.set("times",y[p])})},describeFeatureType:function(t){var o=this,r="DescribeFeatureType",n="WFS",a=t.get("id");return e({method:"GET",url:t.get("url").replace("http:",""),params:{SERVICE:n,VERSION:"1.0.0",REQUEST:r,TYPENAME:a}}).success(function(e){var r=new storytools.edit.WFSDescribeFeatureType.WFSDescribeFeatureType,n=r.parseResult(e);n.timeAttribute?t.set("timeAttribute",n.timeAttribute):t.get("timeEndpoint")&&o.getTimeAttribute(t);var i=a.split(":");t.set("typeName",a),t.set("featurePrefix",i[0]),t.set("featureNS",n.featureNS),t.set("geomType",n.geomType),t.set("attributes",n.attributes)})},getTimeAttribute:function(t){return e({method:"GET",url:t.get("timeEndpoint")}).success(function(e){t.set("timeAttribute",e.attribute),e.endAttribute&&t.set("endTimeAttribute",e.endAttribute)})},getStyleName:function(o){if(o.get("canStyleWMS")){return e({method:"GET",url:o.get("path")+"rest/layers/"+o.get("id")+".json"}).success(function(e){o.set("styleName",e.layer.defaultStyle.name)})}return t.when("")},getFeatures:function(t,o){var r=t.get("id"),n=t.get("url")+"?service=WFS&version=1.1.0&request=GetFeature&typename="+r+"&outputFormat=application/json&srsName="+o.getView().getProjection().getCode();return e({method:"GET",url:n}).success(function(e){var o=(t.getLayer(),(new ol.format.GeoJSON).readFeatures(e));t.set("features",o)})}}}]),n.service("stBaseLayerBuilder",function(){return{buildLayer:function(e){if("MapQuest"===e.type)return new ol.layer.Tile({state:e,title:e.title,group:"background",source:new ol.source.MapQuest({layer:e.layer})});if("HOT"===e.type)return new ol.layer.Tile({state:e,title:e.title,group:"background",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'Tiles courtesy of <a href="//hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,url:"//{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"})});if("OSM"===e.type)return new ol.layer.Tile({state:e,title:e.title,group:"background",source:new ol.source.OSM});if("MapBox"===e.type){var t=new ol.layer.Tile({state:e,title:e.title,group:"background"}),o=e.name,r=["//a.tiles.mapbox.com/v1/mapbox.","//b.tiles.mapbox.com/v1/mapbox.","//c.tiles.mapbox.com/v1/mapbox.","//d.tiles.mapbox.com/v1/mapbox."],n=function(e){var t=e;return t[1]<0||t[2]<0?"":r[Math.round(3*Math.random())]+o+"/"+t[0].toString()+"/"+t[1].toString()+"/"+t[2].toString()+".png"};return t.setSource(new ol.source.TileImage({crossOrigin:null,attributions:[new ol.Attribution({html:/^world/.test(o)?"<a href='//mapbox.com'>MapBox</a> | Some Data &copy; OSM CC-BY-SA | <a href='//mapbox.com/tos'>Terms of Service</a>":"<a href='//mapbox.com'>MapBox</a> | <a href='//mapbox.com/tos'>Terms of Service</a>"})],tileGrid:new ol.tilegrid.TileGrid({origin:[-20037508.34,-20037508.34],resolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,.5971642833948135]}),tileUrlFunction:n})),t}if("WMS"===e.type)return new ol.layer.Tile({group:"background",source:new ol.source.TileWMS({url:e.url,params:e.params})});throw new Error("no type for : "+JSON.stringify(e))}}}),n.service("stEditableLayerBuilder",["$q","stAnnotateLayer","stBaseLayerBuilder",function(e,t){return{buildEditableLayer:function(o,n){var a=new r(o),i=e.defer(),s=[],l=!(o.latlonBBOX&&o.times);l&&s.push(t.loadCapabilities(a));var u=!o.attributes;return u&&s.push(t.describeFeatureType(a)),s.push("VECTOR"!==o.type&&"HEATMAP"!==o.type||o.features?t.getStyleName(a):t.getFeatures(a,n)),e.all(s).then(function(){if(a.get("features")){var e=a.get("times");if(e){var t=e.start||e[0];storytools.core.time.maps.filterVectorLayer(a,{start:t,end:t})}else a.getLayer().getSource().addFeatures(a.get("features"))}else a.setWMSSource();i.resolve(a)},function(){i.reject(arguments)}),i.promise}}}]),n.service("stLayerBuilder",["$q",function(e){return{buildLayer:function(t){var r=new o(t),n=e.defer();return r.setWMSSource(),n.resolve(r),n.promise}}}]),n.service("stStoryMapBaseBuilder",["stBaseLayerBuilder",function(e){return{defaultMap:function(e){e.getMap().setView(new ol.View({center:[0,0],zoom:3})),this.setBaseLayer(e,{title:"World Light",type:"MapBox",name:"world-light"})},setBaseLayer:function(t,o){var r=e.buildLayer(o);t.setBaseLayer(r)}}}]),n.service("stStoryMapBuilder",["stLayerBuilder","stStoryMapBaseBuilder",function(e,t){return{modifyStoryMap:function(o,r){o.clear();var n=storytools.mapstory.MapConfigTransformer.MapConfigTransformer(r);n.id>=0&&(o.set("id",n.id),o.setMode(n.playbackMode),void 0!==r.about&&(o.setStoryTitle(r.about.title),o.setStoryAbstract(r.about.abstract),o.setStoryOwner(r.about.owner)),o.setCenter(n.map.center),o.setZoom(n.map.zoom));for(var a=0,i=n.map.layers.length;i>a;++a){var s=n.map.layers[a];"background"===s.group&&s.visibility===!0?t.setBaseLayer(o,s):e.buildLayer(s,o.getMap()).then(function(e){o.addStoryLayer(e)})}o.getMap().setView(new ol.View({center:n.map.center,zoom:n.map.zoom,minZoom:3,maxZoom:17}))}}}]),n.service("stEditableStoryMapBuilder",["stStoryMapBaseBuilder","stEditableLayerBuilder",function(e,t){return{modifyStoryLayer:function(e,o){var r=e.getProperties(),n=e.getStoryMap();r.type=o?o:"WMS"===r.type?"VECTOR":"WMS","WMS"===r.type&&delete r.features,t.buildEditableLayer(r,n.getMap()).then(function(t){e.setLayer(t.getLayer()),e.set("type",t.get("type"))})},modifyStoryMap:function(o,r){o.clear();var n=storytools.mapstory.MapConfigTransformer.MapConfigTransformer(r);n.id>=0&&(o.set("id",n.id),o.setMode(n.playbackMode),void 0!==r.about&&(o.setStoryTitle(r.about.title),o.setStoryAbstract(r.about.abstract),o.setStoryOwner(r.about.owner)));for(var a=0,i=n.map.layers.length;i>a;++a){var s=n.map.layers[a];"background"===s.group&&s.visibility===!0?e.setBaseLayer(o,s):t.buildEditableLayer(s,o.getMap()).then(function(e){o.addStoryLayer(e)})}o.getMap().setView(new ol.View({center:n.map.center,zoom:n.map.zoom,projection:n.map.projection,minZoom:3,maxZoom:17}))}}}])}(),function(){"use strict";function e(){this.storyPins=[],this.map=null}var t=angular.module("storytools.core.pins",[]),o=storytools.core.maps.pins;e.prototype.pinsChanged=function(e,t){var o;if("delete"==t){for(o=0;o<e.length;o++)for(var r=e[o],n=0,a=this.storyPins.length;a>n;n++)if(this.storyPins[n].id==r.id){this.storyPins.splice(n,1);break}}else if("add"==t)for(o=0;o<e.length;o++)this.storyPins.push(e[o]);else if("change"!=t)throw new Error("action? :"+t);var i=this.storyPins.map(function(e){return e.start_time>e.end_time?storytools.core.utils.createRange(e.end_time,e.start_time):storytools.core.utils.createRange(e.start_time,e.end_time)});this.map.storyPinsLayer.set("times",i),this.map.storyPinsLayer.set("features",this.storyPins)},e.prototype.loadFromGeoJSON=function(e,t,r){if(r&&(this.storyPins=[]),e&&e.features){var n=o.loadFromGeoJSON(e,t);this.pinsChanged(n,"add",!0)}},t.service("StoryPinLayerManager",e),t.constant("StoryPin",o.StoryPin),t.service("stAnnotationsStore",["StoryPinLayerManager",function(e){function t(e){return"/maps/"+e+"/annotations"}function o(e){var o=localStorage.getItem(t(e));return o=null===o?[]:JSON.parse(o)}function r(e,o){localStorage.setItem(t(e),(new ol.format.GeoJSON).writeFeatures(o,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}return{loadAnnotations:function(t,r){return e.loadFromGeoJSON(o(t),r)},deleteAnnotations:function(e){var t=o(),n=e.map(function(e){return e.id});t=t.filter(function(e){return n.indexOf(e.id)<0}),r(t)},saveAnnotations:function(e,t){var n=o(),a=0;n.forEach(function(e){a=Math.max(a,e.id)});var i=[];t.forEach(function(e){"undefined"==typeof e.id&&(e.id=++a);var t=e.clone();void 0!==e.get("start_time")&&t.set("start_time",e.get("start_time")/1e3),void 0!==e.get("end_time")&&t.set("end_time",e.get("end_time")/1e3),i.push(t)}),r(e,i)}}}])}(),function(){"use strict";angular.module("storytools.core.style",["storytools.core.style.ol3StyleConverter","storytools.core.style.svgIcon"])}(),function(){"use strict";var e=angular.module("storytools.core.style.ol3StyleConverter",[]);e.factory("ol3MarkRenderer",["ol3StyleConverter",function(e){return function(t,o){var r=e.getColor("#000000"),n=3,a={color:r,width:n},i=angular.element(e.generateShape({symbol:{shape:t,size:o-n}},new ol.style.Fill(a),new ol.style.Stroke(a)).getImage());return i}}]),e.factory("ol3StyleConverter",["stSvgIcon",function(e){return{generateShapeConfig:function(e,t,o){var r=e.symbol.shape,n=e.symbol.size/2;return"circle"===r?{fill:t,stroke:o,radius:n}:"square"===r?{fill:t,stroke:o,points:4,radius:n,angle:Math.PI/4}:"triangle"===r?{fill:t,stroke:o,points:3,radius:n,angle:0}:"star"===r?{fill:t,stroke:o,points:5,radius:n,radius2:.5*n,angle:0}:"cross"===r?{fill:t,stroke:o,points:4,radius:n,radius2:0,angle:0}:"x"===r?{fill:t,stroke:o,points:4,radius:n,radius2:0,angle:Math.PI/4}:void 0},calculateRotation:function(e,t){return e.symbol&&e.symbol.rotationAttribute?"radians"===e.symbol.rotationUnits?t.get(e.symbol.rotationAttribute):t.get(e.symbol.rotationAttribute)/360*Math.PI:void 0},generateShape:function(t,o,r,n){var a=this.generateShapeConfig(t,o,r);if(a&&n&&(a.rotation=this.calculateRotation(t,n)),t.symbol.graphic){var i=e.getImage(t.symbol.graphic,o.getColor(),r.getColor(),!0);return new ol.style.Icon({src:i.dataURI,rotation:this.calculateRotation(t,n),scale:t.symbol.size/Math.max(i.width,i.height),opacity:t.symbol.opacity})}return"circle"===t.symbol.shape?new ol.style.Circle(a):new ol.style.RegularShape(a)},getText:function(e,t){return e.label&&e.label.attribute?""+t.get(e.label.attribute):void 0},generateText:function(e,t,o){return e.label&&null!==e.label.attribute?new ol.style.Text({fill:new ol.style.Fill({color:e.label.fillColor}),stroke:t,font:e.label.fontStyle+" "+e.label.fontWeight+" "+e.label.fontSize+"px "+e.label.fontFamily,text:this.getText(e,o)}):void 0},getColor:function(e,t){var o=ol.color.asArray(e);return void 0!==t&&(o=o.slice(),o[3]=t/100),"rgba("+o.join(",")+")"},generateCacheKey:function(e,t){var o=this.getText(e,t),r=e.classify&&e.classify.attribute?t.get(e.classify.attribute):void 0,n=e.symbol&&e.symbol.rotationAttribute?t.get(e.symbol.rotationAttribute):void 0;return o+"|"+r+"|"+n},generateStyle:function(e,t){var o,r;this.styleCache_||(this.styleCache_={});var n=JSON.stringify(e);if(this.styleCache_[n]){if(this.styleCache_[n].length)return this.styleCache_[n];if(r=this.generateCacheKey(e,t),this.styleCache_[n][r])return this.styleCache_[n][r]}var a;if(e.stroke){var i;"dashed"===e.stroke.strokeStyle?i=[5]:"dotted"===e.stroke.strokeStyle&&(i=[1,2]),a=new ol.style.Stroke({lineDash:i,color:this.getColor(e.stroke.strokeColor,e.stroke.strokeOpacity),width:e.stroke.strokeWidth})}if(e.classify&&null!==e.classify.attribute){for(var s,l=0,u=e.rules.length;u>l;++l){var c=e.rules[l],y=t.get(e.classify.attribute),p=!1;void 0!==c.value?p=y===c.value:c.range&&(p=y>=c.range.min&&y<=c.range.max),p&&(s=this.generateText(e,a,t),"point"===e.geomType&&c.style.symbol.fillColor?o=[new ol.style.Style({text:s,image:this.generateShape(e,new ol.style.Fill({color:c.style.symbol.fillColor}),a,t)})]:"line"===e.geomType&&c.style.stroke.strokeColor?o=[new ol.style.Style({text:s,stroke:new ol.style.Stroke({color:c.style.stroke.strokeColor,width:2})})]:"polygon"===e.geomType&&c.style.symbol.fillColor&&(o=[new ol.style.Style({text:s,stroke:a,fill:new ol.style.Fill({color:c.style.symbol.fillColor})})]))}o&&(this.styleCache_[n]||(this.styleCache_[n]={}),r=this.generateCacheKey(e,t),this.styleCache_[n][r]=o)}else{var m=new ol.style.Fill({color:this.getColor(e.symbol.fillColor,e.symbol.fillOpacity)});o=[new ol.style.Style({image:this.generateShape(e,m,a,t),fill:m,stroke:a,text:this.generateText(e,a,t)})]}if(o){var g=o[0].getText();g||e.classify&&e.classify.attribute||e.symbol&&e.symbol.rotationAttribute?(this.styleCache_[n]||(this.styleCache_[n]={}),r=this.generateCacheKey(e,t),this.styleCache_[n][r]=o):this.styleCache_[n]=o}return o}}}])}(),function(){"use strict";var e=angular.module("storytools.core.style.svgIcon",[]);e.factory("stSvgIcon",["$cacheFactory","$http","$q","$log",function(e,t,o,r){function n(e,t,o){a.html(e),["path","polygon","circle","ellipse","rect","line","polyline"].forEach(function(e){angular.forEach(a.find(e),function(e){e=angular.element(e);var r={opacity:1},n=e.css("fill")||e.attr("fill")||"";"none"!=n&&"rgb(255, 255, 255)"!=n&&"#ffffff"!=n.toLowerCase()&&(r.fill=t);var a=e.css("stroke")||e.attr("stroke");"none"!=a&&(r.stroke=o),e.css(r)})});var r=a.find("svg"),n=parseInt(r.attr("width")),i=parseInt(r.attr("height"));(isNaN(n)||isNaN(i))&&(r.attr("width",64),r.attr("height",64),n=64,i=64);var s="data:image/svg+xml;base64,"+btoa(a.html());return{dataURI:s,width:n,height:i}}var a=angular.element(document.createElement("div")),i=e("stSvgImage"),s=e("stSvgData");return{getImage:function(e,t,a,l){var u=e+t+a,c=i.get(u),y=o.defer();if(c){if(l)return c;y.resolve(c)}else{if(l){var p=s.get(e);if(p){var m=n(p,t,a);return m.uri=e,i.put(u,m),m}return r.warning("no svg for",e),null}this.getImageData(e).then(function(o){var r=n(o.data,t,a);r.uri=e,i.put(u,r),y.resolve(r)},function(){y.reject("error")})}return y.promise},getImageData:function(e){return t.get(e,{cache:!0}).success(function(t){return s.put(e,t),t}).error(function(){r.warn("error fetching "+e)})}}}])}(),function(){"use strict";var e=angular.module("storytools.core.time.directives",[]);e.directive("stPlaybackControls",function(){return{restrict:"E",templateUrl:"time/playback-controls.html",scope:{timeControls:"=",playbackOptions:"="},link:function(e){e.playbackState="Play",e.loopText="Loop Chapter",e.loopStoryEnabled=!1,e.loopChapterEnabled=!1,e.loop=!1,e.showTimeLine=!1,e.next=function(){e.timeControls.next()},e.prev=function(){e.timeControls.prev()},e.$watch("timeControls",function(t,o){t!==o&&(t.on("stateChange",function(){var t=e.timeControls.isStarted();e.started=t,e.playbackState=t?"Pause":"Play",e.$apply()}),t.on("rangeChange",function(t){e.currentRange=t,e.$apply()}))}),e.play=function(){var t=e.timeControls,o=t.isStarted();o?t.stop():t.start()},e.isInFullScreen=function(e){return void 0!==e.fullScreenElement?!!e.fullScreenElement:void 0!==e.mozFullScreen?!!e.mozFullScreen:void 0!==e.webkitIsFullScreen?!!e.webkitIsFullScreen:void 0!==window.fullScreen?!!window.fullScreen:void 0!==window.navigator.standalone?!!window.navigator.standalone:void 0},e.toggleFullScreen=function(){var e=window.parent.document.getElementById("embedded_map");this.isInFullScreen(document)||this.isInFullScreen(parent.document)?document.mozCancelFullScreen?(parent.document.mozCancelFullScreen(),document.mozCancelFullScreen()):(parent.document.webkitCancelFullScreen(),document.webkitCancelFullScreen()):document.webkitFullScreen&&document.mozFullScreen&&document.msFullscreenElement&&document.fullscreenElement||(e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT))},e.toggleLoop=function(){var t=e.timeControls;"none"===t.loop?(e.loop=t.loop="chapter",e.loopText="Loop Story",e.loopChapterEnabled=!0):"chapter"===t.loop?(e.loop=t.loop="story",e.loopText="Disable Loop",e.loopStoryEnabled=!0,e.loopChapterEnabled=!1):(e.loopText="Loop Chapter",e.loop=t.loop="none",e.loopStoryEnabled=!1,e.loopChapterEnabled=!1)},e.toggleTimeLine=function(){var t=e.timeControls;e.showTimeLine=t.showTimeLine=!t.showTimeLine;var o=$("#timeline");t.showTimeLine?o.show("slow"):o.hide("slow")}}}}),e.directive("stPlaybackSettings",function(){return{restrict:"E",templateUrl:"time/playback-settings.html",scope:{timeControls:"=",playbackOptions:"="},link:function(e){e.optionsChanged=function(){e.timeControls&&e.timeControls.update(e.playbackOptions)}}}})}(),function(){"use strict";var e=angular.module("storytools.core.time",["storytools.core.time.directives","storytools.core.time.services","storytools.core.templates"]);e.filter("isodate",function(){return function(e){return null!==e&&angular.isDefined(e)?angular.isNumber(e)?new Date(e).toISOString():Date.parse(e).toISOString():""}})}(),function(){"use strict";function e(e){function t(e){e=r.getTime(e),null===e||e in n||(n[e]=1)}if(!angular.isArray(e)){var o=e;e=o.getStoryLayers().getArray().filter(function(e){var t=e.get("times");return null!=t}),e.push(o.storyPinsLayer),e.push(o.storyBoxesLayer)}var n={},a=null,i=[];if(e.forEach(function(e){var o,n=e.get("times");angular.isArray(n)?(o=r.computeRange(n),n.length&&n.forEach(r.isRangeLike(n[0])?function(e){t(e.start),null===a?a=r.createRange(e):a.extend(e)}:function(e){t(e)}),null!=o.end&&t(o.end)):n&&(o=n,i.push(n)),null===a?a=r.createRange(o):a.extend(o)}),i.length){i.sort(function(e,t){return e.interval-t.interval});for(var s=i[0],l=a.start;l<=a.end;)t(l),l=s.offset(l)}return n=Object.getOwnPropertyNames(n).map(function(e){return parseInt(e)}),n.sort(function(e,t){return e-t})}function t(t,o,r,n){function a(a){if(t.debug("Creating TimeControls with boxes: "),null===i.timeControls){var s=e(n.storyMap);if(s.length){var l=r.storyPins;i.timeControls=storytools.core.time.create({annotations:l,storyMap:n.storyMap,storyLayers:n.storyMap.getStoryLayers().getArray(),data:s,mode:n.storyMap.mode,tileStatusCallback:function(e){o.$broadcast("tilesLoaded",e)},chapterCount:n.chapterCount}),i.timeControls.on("rangeChange",function(e){i.currentRange=e})}}else if(a){var u=a();u&&i.timeControls.update(u)}}this.timeControls=null;var i=this;n.storyMap.getStoryLayers().on("change:length",function(){a(function(){var t=e(n.storyMap);return t.length?{storyLayers:n.storyMap.getStoryLayers().getArray(),data:t}:void 0})});var s=n.storyMap.storyPinsLayer,l=n.storyMap.storyBoxesLayer;s.on("change:features",function(){a(function(){var t=e(n.storyMap);return t.length?{storyLayers:n.storyMap.getStoryLayers().getArray(),annotations:s.get("features"),boxes:l.get("features"),data:t}:void 0})}),l.on("change:features",function(){a(function(){var t=e(n.storyMap);return t.length?{annotations:s.get("features"),data:t,boxes:l.get("features")}:void 0})}),a()}var o=angular.module("storytools.core.time.services",[]),r=storytools.core.time.utils;o.constant("TimeControlsManager",t),o.service("TimeMachine",function(){return{computeTicks:e}})}();